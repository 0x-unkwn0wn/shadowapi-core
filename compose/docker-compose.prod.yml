version: "3.9"

services:
  migrate:
    image: ${HP_IMAGE:-ghcr.io/<ORG>/shadowapi-core}:${APP_VERSION}
    user: "0:0"
    command: ["sh", "-c", "chown -R 10001:0 /data && alembic upgrade head"]
    env_file:
      - ../.env.prod
    volumes:
      - hp_prod_data:/data
    restart: "no"

  app:
    image: ${HP_IMAGE:-ghcr.io/<ORG>/shadowapi-core}:${APP_VERSION}
    user: "10001:0"
    env_file:
      - ../.env.prod
    environment:
      - PYTHONPATH=/app
    command: ["uvicorn", "app.honeypot_public:app", "--host", "0.0.0.0", "--port", "8000", "--proxy-headers", "--forwarded-allow-ips=127.0.0.1,10.0.0.0/8,172.16.0.0/12,192.168.0.0/16"]
    volumes:
      - hp_prod_data:/data
      - ../data/GeoLite2-Country.mmdb:/app/data/GeoLite2-Country.mmdb:ro
    expose:
      - "8000"
    depends_on:
      migrate:
        condition: service_completed_successfully
    healthcheck:
      test:
        ["CMD", "python", "scripts/check_app_ready.py"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.hp-api.rule=Host(`${HP_PUBLIC_HOST}`)"
      - "traefik.http.routers.hp-api.entrypoints=websecure"
      - "traefik.http.routers.hp-api.tls.certresolver=letsencrypt"
      - "traefik.http.services.hp-api.loadbalancer.server.port=8000"
      - "traefik.http.routers.hp-api.middlewares=hp-public-ratelimit"
      - "traefik.http.middlewares.hp-public-ratelimit.ratelimit.average=${HP_PUBLIC_RATELIMIT_AVG:-120}"
      - "traefik.http.middlewares.hp-public-ratelimit.ratelimit.burst=${HP_PUBLIC_RATELIMIT_BURST:-240}"
      - "traefik.http.routers.hp-health.rule=Host(`${HP_PUBLIC_HOST}`) && (Path(`/health`) || Path(`/status`))"
      - "traefik.http.routers.hp-health.entrypoints=websecure"
      - "traefik.http.routers.hp-health.tls.certresolver=letsencrypt"
      - "traefik.http.routers.hp-health.service=hp-api"
      - "traefik.http.routers.hp-health.priority=100"
      - "traefik.http.routers.hp-health.middlewares=hp-monitor-headers,hp-monitor-ratelimit"
      - "traefik.http.middlewares.hp-monitor-headers.headers.customrequestheaders.X-Internal-Monitor=1"
      - "traefik.http.middlewares.hp-monitor-ratelimit.ratelimit.average=30"
      - "traefik.http.middlewares.hp-monitor-ratelimit.ratelimit.burst=60"
      - "traefik.http.routers.hp-internal.rule=PathPrefix(`/`)"
      - "traefik.http.routers.hp-internal.entrypoints=webinternal"
      - "traefik.http.routers.hp-internal.service=hp-api"
      - "traefik.http.routers.hp-internal.priority=120"
      - "traefik.http.routers.hp-internal.middlewares=hp-monitor-headers,hp-monitor-ratelimit"

  admin:
    image: ${HP_IMAGE:-ghcr.io/<ORG>/shadowapi-core}:${APP_VERSION}
    user: "10001:0"
    env_file:
      - ../.env.prod
    environment:
      - PYTHONPATH=/app
    command: ["uvicorn", "app.panel_mvp:app", "--host", "0.0.0.0", "--port", "9001", "--proxy-headers", "--forwarded-allow-ips=127.0.0.1,10.0.0.0/8,172.16.0.0/12,192.168.0.0/16"]
    volumes:
      - hp_prod_data:/data
      - ../data/GeoLite2-Country.mmdb:/app/data/GeoLite2-Country.mmdb:ro
    expose:
      - "9001"
    ports:
      - "127.0.0.1:9001:9001"
    depends_on:
      migrate:
        condition: service_completed_successfully
    restart: unless-stopped

  traefik:
    image: traefik:v2.11
    restart: unless-stopped
    command:
      - "--api.dashboard=false"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--entrypoints.webinternal.address=:8081"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge=true"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web"
      - "--certificatesresolvers.letsencrypt.acme.email=${ACME_EMAIL}"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
    ports:
      - "80:80"
      - "443:443"
      - "127.0.0.1:8081:8081"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik_letsencrypt:/letsencrypt
    depends_on:
      app:
        condition: service_healthy
      admin:
        condition: service_started

volumes:
  hp_prod_data:
  traefik_letsencrypt:
