{% extends "base.html" %}
{% block content %}

<div class="page-head">
  <div>
    <h1>Actor {{ actor.short }}</h1>
    <div class="sub">{{ actor.actor_id }}</div>
  </div>

  <div class="kpis">
    <div class="kpi">
      <div class="kpi-label">Stage</div>
      <div class="kpi-value">S{{ actor.stage }}</div>
    </div>
    <div class="kpi">
      <div class="kpi-label">Score</div>
      <div class="kpi-value">{{ actor.score }}</div>
    </div>
    <div class="kpi">
      <div class="kpi-label">Visto</div>
      <div class="kpi-value">{{ actor.last_seen_fmt }}</div>
    </div>
  </div>
</div>

<div class="card actor-actions">
  <div class="actor-actions__info">
    <div class="actor-actions__eyebrow">Quick Actions</div>
    <div class="actor-actions__title">Gesti√≥n express del actor</div>
    <div class="actor-actions__subtitle">Archive or review this actor without leaving the page.</div>
  </div>
  <div class="actor-actions__buttons">
    <button class="btn btn-ghost" type="button" data-action="archive" data-busy-text="Actualizando..." onclick="archiveActor(this)">
      <span class="btn-label">{% if actor.is_archived %}Unarchive{% else %}Archive{% endif %}</span>
    </button>
    {% if actor.latest_session_id %}
    <a class="btn btn-outline" href="/dashboard/sessions/{{ actor.latest_session_id }}">
      <span class="btn-label">Open Replay</span>
    </a>
    {% endif %}
    <a class="btn btn-outline" href="/dashboard/actors/{{ actor.actor_id }}/sessions">
      <span class="btn-label">Sessions</span>
    </a>
  </div>
</div>

<div id="actionToast" class="toast" role="status" aria-live="polite"></div>


<!-- Tokens -->
<div class="card">
  <div class="card-head">
    <div class="card-title">Tokens ({{ tokens|length }})</div>
    <div class="card-sub mono">/ <a class="link" href="/">dashboard</a></div>
  </div>

  {% if tokens %}
    <div class="table-wrap">
      <table class="table table-sortable">
        <thead>
          <tr>
            <th data-type="text">Token</th>
            <th data-type="number">Stage</th>
            <th data-type="text">Type</th>
            <th data-type="date">Created</th>
            <th data-type="number">Used</th>
            <th data-type="date">Last Used</th>
          </tr>
        </thead>
        <tbody>
          {% for t in tokens %}
          <tr>
            <td class="mono clip">{{ t.token }}</td>
            <td><span class="pill">S{{ t.stage }}</span></td>
            <td>{{ t.gift_type }}</td>
            <td class="mono">{{ t.created_fmt }}</td>
            <td class="mono">{{ t.used_count }}</td>
            <td class="mono">{{ t.last_used_fmt or "-" }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="muted">Sin tokens</div>
  {% endif %}
</div>

<!-- Events -->
<div class="card">
  <div class="card-head">
    <div class="card-title">Events ({{ events|length }})</div>
  </div>

  {% if events %}
    <div class="table-wrap">
      <table class="table table-sortable" id="eventsTable">
        <thead>
          <tr class="header">
            <th data-type="date">Timestamp</th>
            <th data-type="text">Icon</th>
            <th data-type="text">Kind</th>
            <th data-type="text">Method</th>
            <th data-type="text">Path</th>
            <th data-type="text">IP</th>
            <th data-type="text">Token</th>
            <th data-type="text">Body</th>
          </tr>
          <tr class="table-filters">
            <th><input class="table-filter" data-col="0" placeholder="Filter timestamp" aria-label="Filter timestamp"></th>
            <th><input class="table-filter" data-col="1" placeholder="Filter icon" aria-label="Filter icon"></th>
            <th><input class="table-filter" data-col="2" placeholder="Filter kind" aria-label="Filter kind"></th>
            <th><input class="table-filter" data-col="3" placeholder="Filter method" aria-label="Filter method"></th>
            <th><input class="table-filter" data-col="4" placeholder="Filter path" aria-label="Filter path"></th>
            <th><input class="table-filter" data-col="5" placeholder="Filter IP" aria-label="Filter IP"></th>
            <th><input class="table-filter" data-col="6" placeholder="Filter token" aria-label="Filter token"></th>
            <th><input class="table-filter" data-col="7" placeholder="Filter body" aria-label="Filter body"></th>
          </tr>
        </thead>
        <tbody>
          {% for e in events %}
          <tr>
            <td class="mono">{{ e.ts_fmt }}</td>
            <td>{{ e.icon }}</td>
            <td>{{ e.kind }}</td>
            <td class="mono">{{ e.method }}</td>
            <td class="mono" title="{{ e.path }}">{{ e.path }}</td>
            <td class="mono">
              {% if e.geo_flag %}{{ e.geo_flag }} {% endif %}
              {{ e.ip or '-' }}
            </td>
            <td class="mono" title="{{ e.token }}">{{ e.token if e.token else '-' }}</td>
            <td class="mono" title="{{ e.body_sample }}">{{ e.body_sample if e.body_sample else '-' }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="muted">Sin events</div>
  {% endif %}
</div>

<!-- Auto-refresh (solo si la pestana esta visible) -->
<script>
  const actor_id = "{{ actor.actor_id }}";
  let autoRefreshEnabled = true;
  let toastTimer = null;
  const toastEl = document.getElementById('actionToast');
  let eventsTableHelper = null;

  function ensureEventsTableHelper(){
    if(!eventsTableHelper && window.TableFilterSort){
      eventsTableHelper = window.TableFilterSort.initTable(document.getElementById('eventsTable'));
    }
    return eventsTableHelper;
  }

  const refreshTimer = setInterval(() => {
    if (autoRefreshEnabled && !document.hidden) {
      const helper = ensureEventsTableHelper();
      if (helper && helper.isActive()) return;
      window.location.reload();
    }
  }, 5000);

  function showToast(message, type = 'info'){
    if(!toastEl) return;
    toastEl.textContent = message;
    toastEl.dataset.type = type;
    toastEl.classList.add('is-visible');
    if(toastTimer){ clearTimeout(toastTimer); }
    toastTimer = setTimeout(() => toastEl.classList.remove('is-visible'), 4000);
  }

  function setButtonBusy(btn, busy, label){
    if(!btn) return;
    if(busy){
      if(!btn.dataset.originalLabel){
        btn.dataset.originalLabel = btn.innerHTML;
      }
      btn.innerHTML = `<span class="spinner"></span>${label || btn.dataset.busyText || 'Working...'}`;
    }else if(btn.dataset.originalLabel){
      btn.innerHTML = btn.dataset.originalLabel;
    }
    btn.disabled = !!busy;
    btn.classList.toggle('is-busy', !!busy);
  }

  async function archiveActor(btn){
    const busyText = (btn && btn.dataset && btn.dataset.busyText) ? btn.dataset.busyText : 'Updating...';
    setButtonBusy(btn, true, busyText);
    const is_archived = parseInt("{{ actor.is_archived|default('0') }}");
    const endpoint = is_archived ? 'unarchive' : 'archive';
    const url = `/dashboard/actors/${actor_id}/${endpoint}`;
    try{
      const res = await fetch(url, {method:'POST'});
      if(res.ok){
        showToast(is_archived ? 'Actor unarchived' : 'Actor archived', 'success');
        setTimeout(() => window.location.reload(), 600);
      }else{
        const text = await res.text();
        showToast('Error ' + res.status + ': ' + text, 'error');
      }
    }catch(e){
      showToast('Error: ' + e.message, 'error');
    }finally{
      setButtonBusy(btn, false);
    }
  }

  ensureEventsTableHelper();
</script>

{% endblock %}
