{% extends "base.html" %}
{% block content %}
<a class="back" href="/actor/{{ session.actor_id }}">&larr; Back to actor</a>
<div class="page-head">
  <div>
    <h1>Session {{ session.session_id }}</h1>
    <div class="sub">Actor {{ session.actor_id }} - Stage {{ session.stage_max or 0 }}</div>
  </div>
  <div class="kpis">
    <div class="kpi">
      <div class="kpi-label">Started</div>
      <div class="kpi-value mono">{{ session.started_fmt }}</div>
    </div>
    <div class="kpi">
      <div class="kpi-label">Ended</div>
      <div class="kpi-value mono">{{ session.ended_fmt }}</div>
    </div>
    <div class="kpi">
      <div class="kpi-label">Duration</div>
      <div class="kpi-value">{{ session.duration_seconds or '-' }}s</div>
    </div>
  </div>
</div>

<div class="card session-meta">
  <div class="session-summary">
    <div>
      <div class="muted tiny-text">Summary</div>
      <div>{{ session.summary or 'No summary available' }}</div>
    </div>
    <div>
      <div class="muted tiny-text">Max Stage</div>
      <div class="tag">S{{ session.stage_max or 0 }}</div>
    </div>
  </div>
</div>

<div id="sessionToast" class="toast" role="status" aria-live="polite"></div>

<div class="card">
  <div class="card-head"><div class="card-title">Steps ({{ steps|length }})</div></div>
  <div class="table-wrap">
    <div class="table-toolbar">
      <button class="btn btn-ghost btn-small" type="button" onclick="selectAllSteps(true)">Select all</button>
      <button class="btn btn-ghost btn-small" type="button" onclick="selectAllSteps(false)">Clear</button>
      <span id="selectedCount" class="muted tiny-text"></span>
    </div>
    <table class="table table-sortable" id="stepsTable">
      <thead>
        <tr class="header">
          <th data-type="text"><input type="checkbox" id="selectAllSteps" aria-label="Select all steps"></th>
          <th data-type="number">#</th>
          <th data-type="date">Timestamp</th>
          <th data-type="text">Method</th>
          <th data-type="text">Path</th>
          <th data-type="number">Stage</th>
          <th data-type="number">Status</th>
          <th data-type="text">Actions</th>
        </tr>
        <tr class="table-filters">
          <th></th>
          <th><input class="table-filter" data-col="1" placeholder="Filter #" aria-label="Filter #"></th>
          <th><input class="table-filter" data-col="2" placeholder="Filter timestamp" aria-label="Filter timestamp"></th>
          <th><input class="table-filter" data-col="3" placeholder="Filter method" aria-label="Filter method"></th>
          <th><input class="table-filter" data-col="4" placeholder="Filter path" aria-label="Filter path"></th>
          <th><input class="table-filter" data-col="5" placeholder="Filter stage" aria-label="Filter stage"></th>
          <th><input class="table-filter" data-col="6" placeholder="Filter status" aria-label="Filter status"></th>
          <th><input class="table-filter" data-col="7" placeholder="Filter actions" aria-label="Filter actions"></th>
        </tr>
      </thead>
      <tbody>
        {% for s in steps %}
        {% set stage = s.stage_after if s.stage_after is not none else s.stage_before %}
        <tr>
          <td><input type="checkbox" class="step-select" data-step-id="{{ s.id }}" data-step-seq="{{ s.seq }}" aria-label="Select step {{ s.seq }}"></td>
          <td>{{ s.seq }}</td>
          <td class="mono">{{ s.ts }}</td>
          <td class="mono">{{ s.method }}</td>
          <td class="mono" title="{{ s.path }}">{{ s.path }}</td>
          <td><span class="tag">S{{ stage or 0 }}</span></td>
          <td>{{ s.response_status or '-' }}</td>
          <td class="step-actions"><span class="muted tiny-text">-</span></td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
  const toastEl = document.getElementById('sessionToast');

  function showSessionToast(message, type = 'info'){
    if(!toastEl) return;
    toastEl.textContent = message;
    toastEl.dataset.type = type;
    toastEl.classList.add('is-visible');
    setTimeout(() => toastEl.classList.remove('is-visible'), 3000);
  }

  function updateSelectedCount(){
    const count = document.querySelectorAll('.step-select:checked').length;
    const el = document.getElementById('selectedCount');
    if(el){ el.textContent = count ? `${count} selected` : ''; }
  }

  function selectAllSteps(checked){
    document.querySelectorAll('.step-select').forEach(cb => { cb.checked = checked; });
    const master = document.getElementById('selectAllSteps');
    if(master){ master.checked = checked; }
    updateSelectedCount();
  }

  if(window.TableFilterSort){
    window.TableFilterSort.initTable(document.getElementById('stepsTable'));
  }

  const masterSelect = document.getElementById('selectAllSteps');
  if(masterSelect){
    masterSelect.addEventListener('change', (e) => selectAllSteps(e.target.checked));
  }
  document.querySelectorAll('.step-select').forEach(cb => {
    cb.addEventListener('change', updateSelectedCount);
  });
  updateSelectedCount();
</script>

{% endblock %}
